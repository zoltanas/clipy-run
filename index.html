<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>cli.run â€” Internet of CLI Tools</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.29.3/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@webcontainer/api@1.1.0/dist/index.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.5.0/lib/xterm.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Space+Grotesk:wght@500;600&display=swap');
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: #0a0a0a;
            color: #0f0;
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }
        h1 { 
            font-family: 'Space Grotesk', sans-serif; 
            font-size: 2.8em; 
            margin: 0 0 8px 0; 
            background: linear-gradient(90deg, #0f0, #0a0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
        #term-container {
            background: #000;
            border: 2px solid #0f0;
            border-radius: 12px;
            padding: 16px;
            height: 520px;
            overflow: hidden;
            position: relative;
        }
        #tools-list {
            margin: 20px 0;
            padding: 12px;
            background: #111;
            border-radius: 8px;
            font-size: 0.95em;
        }
        .tool-chip {
            display: inline-block;
            background: #222;
            padding: 6px 12px;
            margin: 4px;
            border-radius: 999px;
            font-size: 0.85em;
            border: 1px solid #0f0;
            cursor: pointer;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
        }
        button:hover { background: #0c0; }
        pre, .xterm { font-family: ui-monospace, monospace; }
        .note { font-size: 0.85em; opacity: 0.7; }
    </style>
</head>
<body>
    <div class="header">
        <h1>cli.run</h1>
        <span class="note">Internet of Private CLI Tools â€” 100% in your browser</span>
    </div>
    
    <p>Registry: <a href="https://github.com/zoltanas/clipy-registry" target="_blank" style="color:#0f0">zoltanas/clipy-registry</a> â€¢ Try <code>cli://pandas?csv=data.csv</code> or go to <a href="/tools">/tools</a></p>

    <div id="tools-list">Loading tools from your registryâ€¦</div>

    <div id="term-container"></div>
    <button onclick="copyJson()" style="margin-top:12px;">ðŸ“‹ Copy JSON for Agents</button>

    <script type="module">
        const REGISTRY_URL = "https://raw.githubusercontent.com/zoltanas/clipy-registry/main/tools.json";
        
        let term;
        let registry = [];
        let currentOutput = { stdout: "", stderr: "", exitCode: 0, artifacts: {} };

        async function initTerminal() {
            term = new Terminal({
                theme: { background: '#000', foreground: '#0f0', cursor: '#0f0' },
                fontSize: 15,
                fontFamily: 'ui-monospace, monospace',
                cols: 80,
                rows: 24
            });
            term.open(document.getElementById('term-container'));
            term.writeln("\x1b[32mcli.run ready â€” waiting for tool...\x1b[0m");
        }

        async function loadRegistry() {
            try {
                const resp = await fetch(REGISTRY_URL);
                registry = await resp.json();
            } catch(e) {
                registry = [
                    { name: "help", runtime: "text", description: "Registry not found â€” add tools.json" },
                    { name: "pandas", runtime: "pyodide", packages: ["pandas"], code: "import pandas as pd\nprint('pandas ready â€” use ?code=your code')" }
                ];
            }
            renderTools();
        }

        function renderTools() {
            const container = document.getElementById('tools-list');
            let html = `<strong>Available Tools (${registry.length}):</strong><br>`;
            registry.forEach(tool => {
                html += `<span class="tool-chip" onclick="runTool('${tool.name}')">${tool.name}</span>`;
            });
            container.innerHTML = html;
        }

        window.runTool = async (toolName) => {
            const url = new URL(location.href);
            url.pathname = '/' + toolName;
            history.pushState({}, '', url);
            await run();
        };

        async function run() {
            if (!term) await initTerminal();
            term.clear();
            term.writeln(`\x1b[32mRunning cli://${location.pathname.slice(1)} ...\x1b[0m`);

            const toolName = location.pathname.slice(1) || 'help';
            const params = Object.fromEntries(new URLSearchParams(location.search));
            
            const manifest = registry.find(t => t.name === toolName) || {name: toolName, runtime: "text"};

            currentOutput = { stdout: "", stderr: "", exitCode: 0, artifacts: {} };

            if (manifest.runtime === 'pyodide') {
                term.writeln("Booting Pyodide sandbox...");
                const pyodide = await loadPyodide();
                await pyodide.loadPackage(manifest.packages || []);
                
                const code = manifest.code || params.code || "print('Tool ready')";
                try {
                    const result = await pyodide.runPythonAsync(code);
                    currentOutput.stdout = String(result);
                    term.writeln(currentOutput.stdout);
                } catch(e) {
                    currentOutput.stderr = e.message;
                    term.writeln("\x1b[31m" + e.message + "\x1b[0m");
                }
            } 
            else if (manifest.runtime === 'webcontainer') {
                term.writeln("Booting WebContainer (Node.js sandbox)...");
                const wc = await WebContainer.boot();
                await wc.mount({ 
                    'package.json': { 
                        file: { contents: manifest.packageJson || '{"dependencies":{}}' } 
                    } 
                });
                await wc.run({ command: 'npm', args: ['install', '--silent'] });
                
                const cmd = manifest.cmd || params.cmd || 'echo';
                const args = manifest.args ? manifest.args.map(a => a.replace(/\{\{([^}]+)\}\}/g, (_, key) => params[key] || '')) : [];
                
                const process = await wc.run({ command: cmd, args });
                currentOutput.exitCode = process;
                term.writeln(`\nâœ“ ${toolName} finished (exit ${process})`);
            } 
            else {
                term.writeln(`\x1b[33mTool "${toolName}" ready (text mode)\x1b[0m`);
                currentOutput.stdout = `Tool: ${toolName}\nParams: ${JSON.stringify(params, null, 2)}`;
            }

            term.writeln("\x1b[32mDone. Copy JSON for agents if needed.\x1b[0m");
        }

        window.copyJson = () => {
            const jsonStr = JSON.stringify(currentOutput, null, 2);
            navigator.clipboard.writeText(jsonStr);
            term.writeln("\x1b[32mJSON copied to clipboard!\x1b[0m");
        };

        // Auto-run if tool in URL
        async function main() {
            await initTerminal();
            await loadRegistry();
            const tool = location.pathname.slice(1);
            if (tool && tool !== 'tools') {
                await run();
            } else if (location.pathname === '/tools') {
                term.writeln("Available tools loaded above â€” click any chip to run");
            }
        }

        main();

        // PWA / protocol hint
        if ('serviceWorker' in navigator) {
            console.log("%ccli.run PWA ready â€” visit once to enable cli:// links", "color:#0f0");
        }
    </script>
</body>
</html>
